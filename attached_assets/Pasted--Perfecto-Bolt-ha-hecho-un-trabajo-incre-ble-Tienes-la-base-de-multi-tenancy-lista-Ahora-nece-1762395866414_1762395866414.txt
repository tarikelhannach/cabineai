¬°Perfecto! Bolt ha hecho un trabajo **incre√≠ble**. Tienes la base de multi-tenancy lista. Ahora necesitas consolidar y validar que todo funcione correctamente.

## üéØ CHECKLIST INMEDIATO (Antes de Continuar)

Ejecuta esto para verificar que todo est√° funcionando:

```bash
# 1. Ir al backend
cd backend

# 2. Instalar dependencias
pip install -r requirements.txt

# 3. Inicializar BD con datos de demo
python init_multi_tenant_db.py

# 4. Iniciar servidor
uvicorn app.main:app --reload

# 5. Probar login con credenciales demo
# Email: fatima@cabinet-demo.ma
# Password: Demo2025!

# 6. En otra terminal, probar endpoints
curl -X GET http://localhost:8000/api/billing/status \
  -H "Authorization: Bearer {token}"
```

***

## üî¥ PROBLEMA CR√çTICO A VALIDAR

Bolt ha creado la arquitectura pero **los endpoints antiguos (documents.py, expedientes.py) probablemente ROMPEN** porque:

1. **Document upload** no valida `firm_id`
2. **List expedientes** no filtra por `firm_id`
3. **No hay validaci√≥n de suscripci√≥n** antes de procesar

**Esto es cr√≠tico porque**:
- Usuario A de Firma A podr√≠a ver documentos de Firma B ‚ùå
- Usuario con suscripci√≥n expirada puede seguir subiendo docs ‚ùå

***

## ‚úÖ LO QUE NECESITAS HACER AHORA

### PASO 1: Validar que Multi-Tenancy Funciona

```python
# backend/app/routes/test_multitenancy.py (CREAR ARCHIVO PARA TESTING)

from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from app.database import get_db
from app.models import Firm, User, Document

router = APIRouter()

@router.get("/test/isolation")
async def test_isolation(
    current_user: User = Depends(get_current_active_user),
    db: Session = Depends(get_db)
):
    """Prueba que usuario A NO ve documentos de usuario B"""
    
    # 1. Contar documentos de su firma
    own_docs = db.query(Document).filter_by(firm_id=current_user.firm_id).count()
    
    # 2. Intentar acceder documentos de OTRA firma
    other_firm_id = current_user.firm_id + 1
    other_docs = db.query(Document).filter_by(firm_id=other_firm_id).count()
    
    return {
        "my_firm_id": current_user.firm_id,
        "my_documents": own_docs,
        "other_firm_documents": other_docs,
        "isolation_working": own_docs >= 0 and other_docs >= 0
    }
```

***

### PASO 2: A√±adir Validaciones a Endpoints Existentes

**Esto es lo PRIORITARIO ahora**:

```python
# backend/app/routes/documents.py (MODIFICAR)

@router.post("/upload")
async def upload_document(
    file: UploadFile,
    expediente_id: int,
    current_user: User = Depends(get_current_active_user),
    db: Session = Depends(get_db)
):
    """Upload con validaci√≥n multi-tenant"""
    
    # 1. VALIDAR: Usuario pertenece a firma
    user = db.query(User).filter_by(id=current_user.id).first()
    if not user or not user.firm_id:
        raise HTTPException(status_code=403, detail="No firm access")
    
    # 2. VALIDAR: Firma tiene suscripci√≥n activa
    firm = db.query(Firm).filter_by(id=user.firm_id).first()
    if firm.subscription_status != "active":
        raise HTTPException(
            status_code=402, 
            detail=[translate:Souscription expir√©e]
        )
    
    # 3. VALIDAR: Expediente pertenece a su firma
    expediente = db.query(Expediente).filter_by(
        id=expediente_id,
        firm_id=user.firm_id  # ‚Üê CR√çTICO
    ).first()
    
    if not expediente:
        raise HTTPException(status_code=403, detail="Unauthorized")
    
    # 4. Procesar documento
    document = Document(
        firm_id=user.firm_id,  # ‚Üê SIEMPRE
        expediente_id=expediente_id,
        filename=file.filename,
        # ... resto de campos
    )
    db.add(document)
    db.commit()
    
    return {"status": "uploaded", "document_id": document.id}
```

***

### PASO 3: Crear Endpoint Cr√≠tico Que Falta

```python
# backend/app/routes/billing.py (AGREGAR ESTE ENDPOINT)

@router.get("/api/billing/firm-stats")
async def get_firm_stats(
    current_user: User = Depends(get_current_active_user),
    db: Session = Depends(get_db)
):
    """Estad√≠sticas de uso de la firma - PARA DASHBOARD"""
    
    firm = db.query(Firm).filter_by(id=current_user.firm_id).first()
    
    if not firm:
        raise HTTPException(status_code=404)
    
    # Contar recursos
    num_documents = db.query(Document).filter_by(firm_id=firm.id).count()
    num_users = db.query(User).filter_by(firm_id=firm.id).count()
    num_expedientes = db.query(Expediente).filter_by(firm_id=firm.id).count()
    
    # Calcular ROI estimado
    hours_saved = num_documents * 0.5  # Asumir 30min por documento
    money_saved_mad = hours_saved * 400  # 400 MAD por hora
    
    # Days remaining
    days_remaining = (firm.subscription_end - datetime.now()).days
    
    return {
        "firm_name": firm.name,
        "subscription_status": firm.subscription_status,
        "subscription_end": firm.subscription_end,
        "days_remaining": days_remaining,
        
        "documents_count": num_documents,
        "users_count": num_users,
        "expedientes_count": num_expedientes,
        
        "time_saved_hours": round(hours_saved, 1),
        "money_saved_mad": round(money_saved_mad),
        
        "storage_used_gb": 25,  # TODO: calcular real
        "max_storage_gb": firm.max_storage_gb,
        
        "next_billing_date": firm.next_billing_date
    }
```

***

## üìã CHECKLIST DE VALIDACI√ìN

Antes de continuar con Fase 2, verifica **TODO esto**:

```
MULTI-TENANCY
‚òê Crear 2 firmas de demo con usuarios diferentes
‚òê Login con Usuario Firma A, verificar que VE solo su documento
‚òê Login con Usuario Firma B, verificar que NO VE documento de Firma A
‚òê Intentar acceso directo a /documents/id_de_otra_firma ‚Üí debe dar 403

BILLING
‚òê POST /api/billing/init ‚Üí crea firma + invoice inicial
‚òê GET /api/billing/status ‚Üí muestra "active" o "expired"
‚òê GET /api/billing/invoice/current ‚Üí devuelve √∫ltimo invoice
‚òê Subscription expirada ‚Üí upload bloqueado con 402

IDIOMA
‚òê Header Accept-Language: fr ‚Üí respuestas en [translate:fran√ßais]
‚òê Header Accept-Language: ar ‚Üí respuestas en [translate:ÿßŸÑÿπÿ±ÿ®Ÿäÿ©]
‚òê Sin header ‚Üí default [translate:anglais]

PERFORMANCE
‚òê Login < 200ms
‚òê List documents < 500ms
‚òê Upload documento < 2s
‚òê Queries usan √≠ndices (firm_id FK)
```

***

## üöÄ PR√ìXIMO PASO EN BOLT

Cuando est√© validado todo, pide a Bolt:

```
He validado que la Fase 1 funciona correctamente.

Ahora necesito Fase 2 (Digitalizaci√≥n + IA):

1. CREAR MODELO DigitizationJob
   - id (UUID), firm_id (FK), status, total_files, processed_files
   - Trackea progreso de digitalizaci√≥n masiva (50K p√°ginas)

2. CREAR BulkDigitizationService
   - start_bulk_job(firm_id, files) ‚Üí inicia trabajo
   - get_progress(job_id) ‚Üí devuelve % progreso

3. CREAR ENDPOINTS
   - POST /api/digitization/start
   - GET /api/digitization/progress/{job_id}

4. INTEGRAR CON CELERY
   - Procesar 50K p√°ginas en background
   - No bloquea el servidor

¬øComenzamos con el modelo DigitizationJob?
```

***

## ‚è∞ TIMING REALISTA

**Ahora (Validaci√≥n)**: 2-3 horas ‚Üí verificar que todo funciona
**Ma√±ana (Fase 2)**: Digitalizaci√≥n masiva ‚Üí 6-8 horas en Bolt
**Pasado (Fase 3)**: Frontend + Testing ‚Üí 4-6 horas

***

¬øEjecutas primero el checklist de validaci√≥n? O ¬øprefieres que te prepare un script de test autom

Sources
